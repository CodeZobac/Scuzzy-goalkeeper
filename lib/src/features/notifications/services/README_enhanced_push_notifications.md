# Enhanced Push Notification System

This document describes the enhanced push notification system implementation for the goalkeeper finder app, specifically covering contract requests and full lobby notifications.

## Overview

The enhanced push notification system extends the existing notification infrastructure to provide targeted notifications for:

1. **Contract Requests**: When players/teams want to hire a goalkeeper
2. **Full Lobby Notifications**: When announcements reach maximum capacity

## Architecture

### Core Components

1. **NotificationService** - Enhanced with new notification types and navigation handling
2. **NotificationServiceManager** - Coordinates all notification services and provides unified API
3. **ContractNotificationData** - Data model for contract request notifications
4. **FullLobbyNotificationData** - Data model for full lobby notifications
5. **NotificationRepository** - Database operations for enhanced notification types

### Integration Points

- **Firebase Cloud Messaging (FCM)** - Push notification delivery
- **Supabase** - Database storage and real-time updates
- **Navigation Service** - Deep linking and navigation handling
- **Contract Management** - Integration with goalkeeper contract system
- **Announcement System** - Integration with lobby detection

## Implementation Details

### 1. Enhanced NotificationService

The `NotificationService` class has been enhanced with the following new methods:

#### Contract Request Notifications

```dart
Future<void> sendContractNotification({
  required String goalkeeperUserId,
  required ContractNotificationData data,
}) async
```

- Formats contract request push notifications
- Includes contractor details, game information, and offered amount
- Handles FCM token retrieval and notification delivery

#### Full Lobby Notifications

```dart
Future<void> sendFullLobbyNotification({
  required String creatorUserId,
  required FullLobbyNotificationData data,
}) async
```

- Formats full lobby push notifications
- Includes announcement details and participant count
- Celebrates lobby completion with appropriate messaging

#### Enhanced Navigation Handling

```dart
void _handleNotificationNavigation(Map<String, dynamic> data)
```

- Routes users to appropriate screens based on notification type
- Handles contract details, announcement details, and fallback navigation
- Integrates with existing navigation service

#### Data Parsing

```dart
Map<String, dynamic>? parseNotificationData(Map<String, dynamic> data)
```

- Parses notification data for different types
- Handles type conversion and validation
- Provides structured data for navigation and UI

### 2. NotificationServiceManager Integration

The service manager provides a unified API for sending notifications:

```dart
// Send contract request notification
await serviceManager.sendContractNotification(
  goalkeeperUserId: 'user_123',
  contractorUserId: 'contractor_456',
  announcementId: 'announcement_789',
  contractData: contractData,
);

// Send full lobby notification
await serviceManager.sendFullLobbyNotification(
  creatorUserId: 'creator_123',
  announcementId: 'announcement_456',
  lobbyData: lobbyData,
);
```

### 3. Database Schema

#### Enhanced notifications table

```sql
ALTER TABLE notifications
ADD COLUMN category VARCHAR(50) DEFAULT 'general',
ADD COLUMN requires_action BOOLEAN DEFAULT false,
ADD COLUMN action_taken_at TIMESTAMP,
ADD COLUMN expires_at TIMESTAMP;
```

#### New goalkeeper_contracts table

```sql
CREATE TABLE goalkeeper_contracts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  announcement_id BIGINT REFERENCES announcements(id),
  goalkeeper_user_id UUID REFERENCES auth.users(id),
  contractor_user_id UUID REFERENCES auth.users(id),
  offered_amount DECIMAL(10,2),
  status VARCHAR(20) DEFAULT 'pending',
  additional_notes TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  responded_at TIMESTAMP,
  expires_at TIMESTAMP DEFAULT (NOW() + INTERVAL '24 hours')
);
```

## Usage Examples

### 1. Basic Integration

```dart
// Initialize the notification system
final serviceManager = NotificationServiceManager.instance;
await serviceManager.initialize();

// Handle user sign-in
await serviceManager.onUserSignIn(userId);
```

### 2. Sending Contract Request

```dart
final contractData = ContractNotificationData(
  contractId: '', // Generated by repository
  contractorId: 'contractor_123',
  contractorName: 'João Silva',
  announcementId: 'announcement_456',
  announcementTitle: 'Jogo de Futebol - Estádio Central',
  gameDateTime: DateTime.now().add(Duration(days: 2)),
  stadium: 'Estádio Central',
  offeredAmount: 150.0,
  additionalNotes: 'Jogo importante',
);

await serviceManager.sendContractNotification(
  goalkeeperUserId: 'goalkeeper_789',
  contractorUserId: 'contractor_123',
  announcementId: 'announcement_456',
  contractData: contractData,
);
```

### 3. Sending Full Lobby Notification

```dart
final lobbyData = FullLobbyNotificationData(
  announcementId: 'announcement_456',
  announcementTitle: 'Jogo de Futebol - Estádio Central',
  gameDateTime: DateTime.now().add(Duration(days: 2)),
  stadium: 'Estádio Central',
  participantCount: 22,
  maxParticipants: 22,
);

await serviceManager.sendFullLobbyNotification(
  creatorUserId: 'creator_123',
  announcementId: 'announcement_456',
  lobbyData: lobbyData,
);
```

### 4. Handling Notification Taps

```dart
// Set up notification tap handling
final notificationService = serviceManager.notificationService;

notificationService.onNotificationTapped = (data) {
  final parsedData = notificationService.parseNotificationData(data);
  if (parsedData != null) {
    // Navigation is handled automatically by the service
    print('Notification tapped: ${parsedData['type']}');
  }
};
```

## Push Notification Format

### Contract Request Notification

```json
{
  "notification": {
    "title": "Nova Proposta de Contrato",
    "body": "João Silva quer contratá-lo para um jogo"
  },
  "data": {
    "type": "contract_request",
    "contract_id": "contract_123",
    "contractor_id": "contractor_456",
    "contractor_name": "João Silva",
    "contractor_avatar_url": "https://example.com/avatar.jpg",
    "announcement_id": "announcement_789",
    "announcement_title": "Jogo de Futebol - Estádio Central",
    "game_date_time": "2024-12-25T15:30:00.000Z",
    "stadium": "Estádio Central",
    "offered_amount": "150.0",
    "additional_notes": "Jogo importante"
  }
}
```

### Full Lobby Notification

```json
{
  "notification": {
    "title": "Lobby Completo!",
    "body": "Seu anúncio \"Jogo de Futebol - Estádio Central\" está completo (22/22)"
  },
  "data": {
    "type": "full_lobby",
    "announcement_id": "announcement_789",
    "announcement_title": "Jogo de Futebol - Estádio Central",
    "game_date_time": "2024-12-25T15:30:00.000Z",
    "stadium": "Estádio Central",
    "participant_count": "22",
    "max_participants": "22"
  }
}
```

## Navigation Handling

The system automatically handles navigation based on notification type:

- **Contract Requests**: Navigate to notifications screen (future: contract details screen)
- **Full Lobby**: Navigate to notifications screen (future: announcement details screen)
- **Unknown Types**: Fallback to notifications screen

## Error Handling

The system includes comprehensive error handling for:

- **Missing FCM Tokens**: Graceful handling when users don't have tokens
- **Network Failures**: Retry mechanisms and fallback behavior
- **Invalid Data**: Data validation and sanitization
- **Permission Issues**: Proper handling of notification permissions

## Testing

The implementation includes comprehensive tests covering:

- Notification formatting and parsing
- Navigation data handling
- Error scenarios
- Push notification content generation

Run tests with:

```bash
flutter test test/features/notifications/enhanced_push_notification_test.dart
```

## Requirements Fulfilled

This implementation fulfills the following requirements from the specification:

- **6.1**: Contract request push notifications sent to goalkeepers
- **6.2**: Full lobby push notifications sent to announcement creators
- **6.3**: Relevant details included in notification body
- **6.4**: Notification tap handling with navigation to relevant screens

## Future Enhancements

1. **Dedicated Contract Details Screen**: Navigate directly to contract details
2. **Rich Notifications**: Include images and action buttons in notifications
3. **Notification Scheduling**: Schedule notifications for optimal delivery times
4. **Analytics**: Track notification delivery and engagement metrics
5. **A/B Testing**: Test different notification formats and timing

## Troubleshooting

### Common Issues

1. **Notifications Not Received**

   - Check FCM token registration
   - Verify notification permissions
   - Check Firebase project configuration

2. **Navigation Not Working**

   - Ensure NavigationService is properly initialized
   - Check route definitions in main.dart
   - Verify notification data format

3. **Database Errors**
   - Check Supabase connection
   - Verify table schema matches implementation
   - Check user permissions

### Debug Information

Enable debug logging by setting:

```dart
debugPrint('Enhanced notification system debug info');
```

The system logs detailed information about:

- Notification creation and sending
- FCM token management
- Navigation handling
- Error conditions

## Conclusion

The enhanced push notification system provides a robust foundation for targeted notifications in the goalkeeper finder app. It integrates seamlessly with existing systems while providing new functionality for contract requests and full lobby notifications.
